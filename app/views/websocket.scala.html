@()
<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>WebSocket Test</title>
    <script language="javascript" type="text/javascript">
        var eventData = function(userId, onError, onMessage, onOnline, onOffline){
            if("WebSocket" in window)
            {
                if(typeof onOnline !== "function") onOnline = function(){console.log('on');};
                if(typeof onOffline !== "function") onOffline = function(){console.log('off');};
                var wsUri = "ws://localhost:9000/out/websocket/"+userId;
                var isConnected = false;
                var websocket = null;
                var connect = function(){
                    if(!this.isConnected)
                    {
                        websocket = new WebSocket(wsUri);
                        websocket.onopen = function(evt){
                            this.isConnected = true;
                            onOnline();
                        };
                        websocket.onclose = function(evt){
                            this.isConnected = false;
                            onOffline();
                            window.setInterval(connect, 3000);
                        };
                        websocket.onmessage = function(evt){
                            var data = JSON.parse(evt.data);
                            if(!data || !data.hasOwnProperty('key') || !data.hasOwnProperty('value'))
                            {
                                onError("Invalid message format!");
                            }else{
                                data.value = parseInt(data.value);
                                if(data.value > 50 || data.value < -50) onError("Invalid message format!");
                                else onMessage(data);
                            }
                        };
                        websocket.onerror = function(evt){
                            console.log(evt);
                            onError("Event message error!");
                        };
                    }
                };
                connect();
            }else onError("WebSocket not supported!");
            return websocket;
        }
    </script>
</head>
<h2>WebSocket Test</h2>
<script language="javascript" type="text/javascript">
    var socket = eventData(1, function(msg){console.log(msg);}, function(data){console.log(data);}, null, null);
</script>

